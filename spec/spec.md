# E2EE年賀状  

LLM向け 企画書・仕様書（統合版 / v0.1）

---

## 1. 企画書

### 1.1 概要

**E2EE年賀状**は、年賀状の本文をPGPで暗号化し、紙媒体として安全にやり取りするための作成・復号支援ツールである。  
React SPAとして提供し、年賀状の作成、印刷、OCRによる復号補助までを一貫して支援する。

### 1.2 解決したい課題

- 紙の年賀状は第三者に内容を見られるリスクがある
- PGPは安全だが、鍵管理・暗号化・復号の手順が煩雑
- 紙に印刷されたPGPメッセージはOCR誤読が起きやすい

### 1.3 提供価値

- **作成者**：PGP暗号化・レイアウト・分割・印刷を自動化
- **受取人**：OCR＋チェックサム＋誤り位置推定により復号失敗を大幅削減
- **共通**：Fingerprint明示により「どの鍵で暗号化されたか」を明確化

### 1.4 想定ユーザー

- PGP利用者（エンジニア、学生、セキュリティコミュニティ）
- 紙で安全にメッセージを渡したい個人・小規模グループ

### 1.5 アプリ形態

- React SPA（PC / モバイルブラウザ対応）
- オフライン動作可能（KeyServer検索を除く）

---

## 2. 基本方針・前提

- 秘密鍵はアプリ内で扱わない（MVP）
- 復号はユーザーの `gpg` 等の外部ツールで行う
- 公開鍵はFingerprintを主キーとして管理
- 年賀状は **宛先ごとに個別暗号化・個別出力** を行う

---

## 3. 年賀状に印字される情報

- PGPメッセージ（ASCII armored）
- 差出人 Fingerprint
- 受取人 Fingerprint（1枚につき1人）
- OCR補助用チェックサム（誤読検出＋位置推定用）
- 分割情報（例：`PAGE 2 / 5`）

---

## 4. 機能仕様

### 4.1 PGP連絡先（公開鍵）管理

- KeyServer検索（email / name / fingerprint）
- 公開鍵インポート（armored text / .asc ファイル）
- ローカル保存（Fingerprint主キー）
- 表示名はローカルラベルとして管理

---

### 4.2 年賀状作成機能

#### 4.2.1 暗号化方式

- 宛先が複数の場合：
  - **宛先ごとに個別暗号化**
  - 宛先人数分の年賀状データを生成
- 利点：
  - 暗号文長の抑制
  - レイアウト崩れ防止
  - 宛先ごとの独立性確保

#### 4.2.2 長文対応（分割機能）

- PGPメッセージが1枚に収まらない場合：
  - 自動で複数ハガキに分割
  - 各ページに `PAGE X / N` を明示
- 分割単位：
  - ASCII armor ブロックを論理的に分割
  - 行単位での分割を基本とする

#### 4.2.3 出力形式

- SVG（1ページ＝1SVG）
- PDF（複数ページ対応）
- 用紙テンプレ（はがきサイズ固定、MVP）

---

### 4.3 OCR復号支援機能

#### 4.3.1 入力方法

- カメラによるリアルタイムOCR
- 画像ファイルアップロード（PNG / JPG）

#### 4.3.2 OCR処理

- PGPブロック領域を自動検出
- OCR結果を正規化（改行・空白・ヘッダ処理）

---

### 4.4 チェックサム仕様（拡張）

#### 4.4.1 目的

- OCR誤読の検出
- 誤読位置の **部分特定**

#### 4.4.2 設計方針

- 全体チェックサム + 分割チェックサム方式
- 例：
  - PGPメッセージを固定長ブロック（例：256文字）に分割
  - 各ブロックごとに短縮チェックサムを計算
- 印字例：

  ```
  CHECKSUM:
  [1] A3F9
  [2] 91C2
  [3] 7E0B
  ```

#### 4.4.3 効果

- 不一致ブロック番号から「怪しい位置」を特定可能
- 手修正モードでのハイライトに利用

---

### 4.5 手書き修正モード（高度支援）

#### 4.5.1 ハイライト機能

- 誤読しやすい文字を自動強調表示
  - `0 / O`
  - `1 / I / l`
  - `S / 5`
  - `B / 8` 等
- チェックサム不一致ブロックに属する文字列を強調

#### 4.5.2 UI挙動

- OCR結果テキストを編集可能
- ハイライトは色分け表示
  - 黄色：誤読しやすい文字
  - 赤：チェックサム的に疑わしい領域
- 編集後、再チェックサム計算 → 一致判定

---

### 4.6 復号支援

- チェックサムがすべて一致した場合：
  - 復号コマンドを自動生成
- 例：

  ```sh
  gpg --decrypt message.asc
  ```

- クリップボードコピー対応
- ファイル保存用の案内も表示

---

## 5. データモデル（概要）

### ContactKey

- fingerprint: string (PK)
- label: string
- armoredPublicKey: string
- source: keyserver | import
- createdAt: datetime

### PostcardDraft

- id
- plaintext
- recipientFingerprint
- encryptedMessage
- pages[]
- checksums[]

### AppSettings

- keyServerURL
- templateId
- checksumBlockSize

---

## 6. セキュリティ・非機能要件

- 秘密鍵は一切保存・処理しない
- ローカルデータはIndexedDBに保存
- 通信はKeyServer検索時のみ
- ログ送信・解析送信なし

---

## 7. MVP範囲外（将来拡張）

- ブラウザ内復号（WebCrypto + 秘密鍵）
- 年賀状デザインエディタ
- QRコード併用モード
- 鍵信頼モデル（Web of Trust）

---

## 8. 成功条件

- 宛先1人あたり年賀状作成〜印刷まで数分以内
- OCR＋手修正で復号成功率が大幅に向上
- gpgで問題なく復号可能であること

---

（この文書はLLMによる実装・設計補助を前提とした企画書・仕様書である）
