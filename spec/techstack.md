# E2EE年賀状 — 技術選定ドキュメント（v0.2）

## 1. フロントエンド基盤

### 1.1 フレームワーク

- **React（TypeScript）**
  - コンポーネントベースのUI構築
  - 型安全な開発

### 1.2 ビルドツール

- **Vite**
  - 高速な開発体験
  - React + TypeScript の標準組み合わせ

### 1.3 UI / スタイル

- **Tailwind CSS**
  - ユーティリティファースト
  - デザイン一貫性・生産性向上
- **shadcn/ui**
  - Tailwind と統合されたアクセシブルな UI コンポーネント
  - TypeScript 対応

---

## 2. PGP 暗号処理

### 2.1 ライブラリ

- **OpenPGP.js**
  - ブラウザでの公開鍵インポート
  - 公開鍵による暗号化
  - Fingerprint 取得

### 2.2 方針

- 秘密鍵はアプリ内で扱わない（MVP）
- 暗号化のみ実装し、復号は外部 `gpg` を推奨

---

## 3. 年賀状出力

### 3.1 SVG 生成

- **Satori**
  - React/JSX から SVG 生成
  - 年賀状テンプレをコードとして記述
  - テキスト・フォント制御が柔軟
  - 分割ページ（複数SVG）の生成に適合

### 3.2 PDF 生成

- **pdf-lib**
  - 生成した SVG を PDF に埋め込み
  - 複数ページ対応
  - ブラウザのみで完結

### 3.3 出力形式

- SVG（1ページ1SVG）
- PDF（複数ページまとめ）

#### 3.3.1 宛先ごとの個別出力

- 複数宛先は宛先ごとに暗号化・SVG/PDFを生成
- 収まり問題を回避

### 3.4 レイアウト

- はがきテンプレ固定（MVP）
- 余白・フォントサイズ・改行ルールはテンプレで制御

---

## 4. OCR（文字認識）

### 4.1 エンジン

- **Tesseract.js**
  - WASM 実装
  - 主要言語対応
  - 画像ファイル／カメラから入力

### 4.2 入力方式

- 画像ファイルアップロード（PNG/JPEG）
- Web カメラキャプチャ（MediaDevices API）

### 4.3 前処理（必要に応じて）

- Canvas API
  - 明度・二値化
  - 傾き補正
- （オプション）**opencv.js**
  - 高度な前処理が必要な場合導入

---

## 5. チェックサム設計

### 5.1 要件

- OCR 誤読の検出
- 誤読エリアの推定

### 5.2 実装

- ブロック分割（例：256文字/ブロック）
- Web Crypto API でハッシュ算出
  - 短縮表示（Base32 など）
- 印字例：

  ```
  CHECKSUM:
  [1] ABCD
  [2] 91F3
  [3] 7E0B
  ```

### 5.3 効果

- 不一致ブロックを特定
- 手書き修正モードでエリアハイライト

---

## 6. 手書き修正モード

### 6.1 ハイライト対象

- OCR 誤認識しやすい文字
  - `0` / `O`
  - `1` / `I` / `l`
  - `S` / `5`
  - `B` / `8`

### 6.2 UI 機能

- OCR 結果のテキストを編集可能
- 誤認識可能箇所を色分け表示
  - 黄色：誤認識しやすい文字
  - 赤：チェックサム不一致ブロック

### 6.3 再チェック

- 編集後に再度チェックサム照合・復号支援へ

---

## 7. 復号支援

### 7.1 コマンド生成

- OCR + チェックサム一致 → 自動生成

  ```
  gpg --decrypt message.asc
  ```

- クリップボードコピー／ファイル出力ガイド

### 7.2 方針

- ブラウザ内復号は扱わない（MVP）
- 秘密鍵管理はユーザー側の環境で実施

---

## 8. 永続化・状態管理

### 8.1 永続化

- **IndexedDB（idb ラッパー）**
  - 鍵情報・ドラフト保存
  - 大容量データ対応

### 8.2 状態管理

- **Zustand / Recoil**
  - 軽量で React に親和性の高い状態管理

---

## 9. KeyServer 連携

### 9.1 対応

- HKP / WKD 形式の KeyServer
- 検索パラメータ：email / name / fingerprint
- 結果から公開鍵インポート

### 9.2 キャッシュ

- React Query (TanStack Query) で検索キャッシュ

---

## 10. エラー処理・UX

### 10.1 OCR の誤読対策

- 誤認識文字を UI で強調
- 再撮影／画像アップロード誘導

### 10.2 チェックサム不一致

- エラー箇所をブロック単位で表示
- 再 OCR／手動修正ガイド

---

## 11. セキュリティ要件

- 秘密鍵は一切保存・操作しない
- データ送信は KeyServer 検索時のみ
- CSP / 依存ライブラリの固定
- 外部トラッキング・ログ送信なし

---

## 12. MVP 範囲

| 項目 | MVP |
|------|------|
| PGP 暗号化 | あり |
| 秘密鍵 | なし |
| OCR | あり |
| 手書き修正支援 | 基本あり |
| ブラウザ内復号 | なし |
| 年賀状デザインエディタ | なし |
| QR/バーコード | なし |

---

## 13. ツール・ライブラリ一覧

| 用途 | 技術 |
|------|------|
| フロントエンド | React + TypeScript + Vite |
| UI | Tailwind CSS + shadcn/ui |
| 状態管理 | Zustand / Recoil |
| PGP | OpenPGP.js |
| SVG 生成 | Satori |
| PDF 生成 | pdf-lib |
| OCR | Tesseract.js |
| 画像処理 | Canvas API / opencv.js (必要時) |
| 永続化 | IndexedDB (idb) |
| サーバ連携 | React Query |
